<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>WebSocket Analytics Demo - Wontum Player</title>
		<style>
			* {
				margin: 0;
				padding: 0;
				box-sizing: border-box;
			}

			body {
				font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
				background: #0f172a;
				color: #e2e8f0;
				padding: 20px;
			}

			.container {
				max-width: 1400px;
				margin: 0 auto;
			}

			h1 {
				font-size: 2rem;
				margin-bottom: 10px;
				background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);
				-webkit-background-clip: text;
				-webkit-text-fill-color: transparent;
				background-clip: text;
			}

			.subtitle {
				color: #94a3b8;
				margin-bottom: 30px;
			}

			.grid {
				display: grid;
				grid-template-columns: 2fr 1fr;
				gap: 20px;
				margin-bottom: 20px;
			}

			@media (max-width: 1024px) {
				.grid {
					grid-template-columns: 1fr;
				}
			}

			.player-section {
				background: #1e293b;
				border-radius: 12px;
				overflow: hidden;
				box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
			}

			#player-container {
				width: 100%;
				aspect-ratio: 16/9;
			}

			.analytics-panel {
				background: #1e293b;
				border-radius: 12px;
				padding: 20px;
				box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
			}

			.panel-header {
				display: flex;
				align-items: center;
				gap: 10px;
				margin-bottom: 15px;
				padding-bottom: 15px;
				border-bottom: 2px solid #334155;
			}

			.status-indicator {
				width: 12px;
				height: 12px;
				border-radius: 50%;
				background: #ef4444;
				animation: pulse 2s ease-in-out infinite;
			}

			.status-indicator.connected {
				background: #10b981;
			}

			@keyframes pulse {
				0%,
				100% {
					opacity: 1;
				}
				50% {
					opacity: 0.5;
				}
			}

			.panel-title {
				font-size: 1.2rem;
				font-weight: 600;
			}

			.metrics-grid {
				display: grid;
				grid-template-columns: repeat(2, 1fr);
				gap: 15px;
				margin-bottom: 20px;
			}

			.metric-card {
				background: #0f172a;
				padding: 15px;
				border-radius: 8px;
				border-left: 3px solid #3b82f6;
			}

			.metric-label {
				font-size: 0.75rem;
				color: #94a3b8;
				text-transform: uppercase;
				letter-spacing: 0.5px;
				margin-bottom: 5px;
			}

			.metric-value {
				font-size: 1.5rem;
				font-weight: 700;
				color: #3b82f6;
			}

			.events-section {
				background: #1e293b;
				border-radius: 12px;
				padding: 20px;
				box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
				max-height: 500px;
			}

			.events-header {
				font-size: 1.2rem;
				font-weight: 600;
				margin-bottom: 15px;
				padding-bottom: 15px;
				border-bottom: 2px solid #334155;
				display: flex;
				justify-content: space-between;
				align-items: center;
			}

			.clear-btn {
				background: #ef4444;
				color: white;
				border: none;
				padding: 6px 12px;
				border-radius: 6px;
				font-size: 0.85rem;
				cursor: pointer;
				transition: background 0.2s;
			}

			.clear-btn:hover {
				background: #dc2626;
			}

			.events-list {
				max-height: 400px;
				overflow-y: auto;
			}

			.events-list::-webkit-scrollbar {
				width: 8px;
			}

			.events-list::-webkit-scrollbar-track {
				background: #0f172a;
				border-radius: 4px;
			}

			.events-list::-webkit-scrollbar-thumb {
				background: #334155;
				border-radius: 4px;
			}

			.events-list::-webkit-scrollbar-thumb:hover {
				background: #475569;
			}

			.event-item {
				background: #0f172a;
				padding: 12px;
				margin-bottom: 8px;
				border-radius: 6px;
				border-left: 3px solid #8b5cf6;
				font-size: 0.85rem;
				animation: slideIn 0.3s ease;
			}

			@keyframes slideIn {
				from {
					opacity: 0;
					transform: translateX(-10px);
				}
				to {
					opacity: 1;
					transform: translateX(0);
				}
			}

			.event-type {
				font-weight: 600;
				color: #8b5cf6;
				margin-bottom: 4px;
			}

			.event-time {
				font-size: 0.75rem;
				color: #64748b;
			}

			.event-data {
				font-size: 0.75rem;
				color: #94a3b8;
				margin-top: 6px;
				font-family: "Courier New", monospace;
			}

			.connection-info {
				background: #0f172a;
				padding: 12px;
				border-radius: 6px;
				margin-bottom: 15px;
				font-size: 0.85rem;
				color: #64748b;
			}

			.connection-url {
				color: #3b82f6;
				font-family: "Courier New", monospace;
			}
		</style>
	</head>
	<body>
		<div class="container">
			<h1>ðŸ“Š WebSocket Analytics Demo</h1>
			<p class="subtitle">Real-time video analytics streaming with Wontum Player</p>

			<div class="grid">
				<div class="player-section">
					<div id="player-container"></div>
				</div>

				<div class="analytics-panel">
					<div class="panel-header">
						<div class="status-indicator" id="wsStatus"></div>
						<div class="panel-title">Live Analytics</div>
					</div>

					<div class="connection-info"><strong>WebSocket:</strong> <span class="connection-url" id="wsUrl">Connecting...</span></div>

					<div class="metrics-grid">
						<div class="metric-card">
							<div class="metric-label">Total Events</div>
							<div class="metric-value" id="eventCount">0</div>
						</div>
						<div class="metric-card">
							<div class="metric-label">Play Time</div>
							<div class="metric-value" id="playTime">0s</div>
						</div>
						<div class="metric-card">
							<div class="metric-label">Buffer Time</div>
							<div class="metric-value" id="bufferTime">0s</div>
						</div>
						<div class="metric-card">
							<div class="metric-label">Rebuffers</div>
							<div class="metric-value" id="rebufferCount">0</div>
						</div>
					</div>
				</div>
			</div>

			<div class="events-section">
				<div class="events-header">
					<span>ðŸ“¡ Real-time Events Stream</span>
					<button class="clear-btn" onclick="clearEvents()">Clear</button>
				</div>
				<div class="events-list" id="eventsList"></div>
			</div>
		</div>

		<script type="module">
			import { WontumPlayer } from "../dist/wontum-player.esm.js"

			// Mock WebSocket server for demo (in production, use your real WebSocket server)
			const WS_URL = "wss://echo.websocket.org" // Echo server for demo

			// Track events for display
			let eventsReceived = []

			// Create WebSocket connection with custom handlers
			const ws = new WebSocket(WS_URL)

			ws.addEventListener("message", (event) => {
				// In a real app, your WebSocket server would receive these messages
				console.log("WebSocket received:", event.data)
			})

			// Initialize player with WebSocket analytics
			const player = new WontumPlayer({
				src: "https://test-streams.mux.dev/x36xhzz/x36xhzz.m3u8", // Demo HLS stream
				container: "#player-container",
				autoplay: false,
				muted: false,
				controls: true,
				analytics: {
					enabled: true,
					userId: `user_${Math.random().toString(36).substr(2, 9)}`,
					videoId: "demo_video_websocket",
					sessionId: `session_${Date.now()}`,
					// WebSocket configuration
					webSocket: {
						connection: ws,
						// Transform event to custom format
						transform: (event) => ({
							action: "video_analytics",
							timestamp: new Date(event.timestamp).toISOString(),
							event_type: event.eventType,
							video_id: event.videoId,
							user_id: event.userId,
							session_id: event.sessionId,
							metrics: {
								playTime: event.data.totalPlayTime,
								bufferTime: event.data.totalBufferTime,
								rebuffers: event.data.rebufferCount,
								seeks: event.data.seekCount,
							},
						}),
						onOpen: (event) => {
							console.log("âœ… WebSocket connected")
							document.getElementById("wsStatus").classList.add("connected")
							document.getElementById("wsUrl").textContent = WS_URL
						},
						onError: (error) => {
							console.error("âŒ WebSocket error:", error)
							document.getElementById("wsStatus").classList.remove("connected")
						},
						onClose: (event) => {
							console.log("ðŸ”Œ WebSocket disconnected")
							document.getElementById("wsStatus").classList.remove("connected")
						},
						autoReconnect: true,
						reconnectDelay: 3000,
					},
				},
			})

			// Listen to player events to display in UI
			const eventTypes = ["play", "pause", "ended", "seeking", "seeked", "timeupdate", "volumechange", "qualitychange", "waiting", "playing", "error"]

			eventTypes.forEach((eventType) => {
				player.on(eventType, (event) => {
					// Don't show timeupdate events (too frequent)
					if (eventType === "timeupdate") return

					addEventToList(eventType, event.data)
					updateMetrics()
				})
			})

			function addEventToList(eventType, data) {
				eventsReceived.push({ type: eventType, data, time: new Date() })

				const eventsList = document.getElementById("eventsList")
				const eventItem = document.createElement("div")
				eventItem.className = "event-item"

				const time = new Date().toLocaleTimeString()
				const dataStr = data ? JSON.stringify(data, null, 2).substring(0, 100) : ""

				eventItem.innerHTML = `
					<div class="event-type">${eventType}</div>
					<div class="event-time">${time}</div>
					${dataStr ? `<div class="event-data">${dataStr}...</div>` : ""}
				`

				eventsList.insertBefore(eventItem, eventsList.firstChild)

				// Keep only last 50 events in DOM
				while (eventsList.children.length > 50) {
					eventsList.removeChild(eventsList.lastChild)
				}
			}

			function updateMetrics() {
				const metrics = player.analytics.getMetrics()

				document.getElementById("eventCount").textContent = eventsReceived.length
				document.getElementById("playTime").textContent = `${Math.round(metrics.totalPlayTime / 1000)}s`
				document.getElementById("bufferTime").textContent = `${Math.round(metrics.totalBufferTime / 1000)}s`
				document.getElementById("rebufferCount").textContent = metrics.rebufferCount
			}

			// Make clearEvents global
			window.clearEvents = function () {
				eventsReceived = []
				document.getElementById("eventsList").innerHTML = ""
				updateMetrics()
			}

			// Update metrics every second
			setInterval(updateMetrics, 1000)
		</script>
	</body>
</html>
